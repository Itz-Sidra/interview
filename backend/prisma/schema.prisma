generator client {
  provider = "prisma-client-js"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum InterviewType {
  TECHNICAL
  BEHAVIORAL
  SYSTEM_DESIGN
}

enum MediaType {
  AUDIO
  VIDEO
  OTHER
}

enum AnalysisCategory {
  COMMUNICATION
  GRAMMAR
  FILLER_WORDS
  CONFIDENCE
  TECHNICAL
  VOCAL
  EMOTIONAL
}

model User {
  id               String            @id @default(uuid())
  name             String
  email            String            @unique
  passwordHash     String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  resumes          Resume[]
  interviewConfigs InterviewConfig[]
  interviews       Interview[] 

  refreshTokens    RefreshToken[]
}

model Resume {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  config      InterviewConfig @relation(fields: [configId], references: [id])
  configId    String   @unique
  s3Key       String
  textExtract String?
  parsedJson  Json?
  createdAt   DateTime @default(now())
}


model InterviewConfig {
  id              String        @id @default(uuid())
  user            User          @relation(fields: [userId], references: [id])
  userId          String
  role            String
  skills          String[]
  durationMinutes Int
  difficulty      Difficulty
  type            InterviewType
  createdAt       DateTime      @default(now())
  resume          Resume?
  interviews      Interview[]
}

model Interview {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String 

  config   InterviewConfig @relation(fields: [configId], references: [id])
  configId String

  startedAt    DateTime?
  endedAt      DateTime?
  status       String
  overallScore Float?
  createdAt    DateTime  @default(now())

  media       Media[]
  transcripts Transcript[]
  report      AnalysisReport?
  issues      FlaggedIssue[]
  questions   Question[] 

  interviewerModel String?
  consentRecording Boolean @default(false)
  region           String?
  indexes          String?

  @@index([configId])
  @@index([createdAt])
}

model Media {
  id          String    @id @default(uuid())
  interview   Interview @relation(fields: [interviewId], references: [id])
  interviewId String
  s3Key       String
  s3Url       String?
  mediaType   MediaType
  durationMs  Int?
  sizeBytes   Int?
  uploadedAt  DateTime  @default(now())
  processed   Boolean   @default(false)
  notes       String?
}

model Transcript {
  id            String    @id @default(uuid())
  interview     Interview @relation(fields: [interviewId], references: [id])
  interviewId   String
  speaker       String
  text          String    @db.Text
  startTimeMs   Int?
  endTimeMs     Int?
  createdAt     DateTime  @default(now())
  embeddingJson Json?
  tokensJson    Json?
}

model AnalysisReport {
  id              String                  @id @default(uuid())
  interview       Interview               @relation(fields: [interviewId], references: [id])
  interviewId     String                  @unique
  overallScore    Float
  metrics         Json
  perCategory     AnalysisCategoryScore[]
  recommendations Json?
  generatedAt     DateTime                @default(now())
}

model AnalysisCategoryScore {
  id       String           @id @default(uuid())
  report   AnalysisReport   @relation(fields: [reportId], references: [id])
  reportId String
  category AnalysisCategory
  score    Float
  details  Json?
}

model FlaggedIssue {
  id          String           @id @default(uuid())
  interview   Interview        @relation(fields: [interviewId], references: [id])
  interviewId String
  category    AnalysisCategory
  timestampMs Int?
  description String
  severity    Int
  createdAt   DateTime         @default(now())
}

model Question {
  id             String     @id @default(uuid())
  interview      Interview? @relation(fields: [interviewId], references: [id])
  interviewId    String?
  prompt         String     @db.Text
  expectedAnswer Json?
  createdAt      DateTime   @default(now())
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  revoked   Boolean  @default(false)
}
